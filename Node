#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
from std_msgs.msg import Float64
from sensor_msgs.msg import JointState
import time
import math

class SmartArmController(Node):
    def __init__(self):
        super().__init__('arm_controller')
        
        self.pub_j1 = self.create_publisher(Float64, '/arm/j1/cmd_pos', 10)
        self.pub_j2 = self.create_publisher(Float64, '/arm/j2/cmd_pos', 10)
        self.pub_j3 = self.create_publisher(Float64, '/arm/j3/cmd_pos', 10)
        
        self.sub_joints = self.create_subscription(
            JointState,
            '/joint_states',
            self.joint_callback,
            10
        )
        
        self.current_joints = {'world_yaw_joint': 0.0, 'j2_shoulder': 0.0, 'j3_elbow': 0.0}
        self.data_received = False

        print("Sistem Başlatıldı. Robot verisi bekleniyor...")

    def joint_callback(self, msg):
        """Robottan gelen gerçek konum verisini işler"""
        self.data_received = True
        for i, name in enumerate(msg.name):
            if name in self.current_joints:
                self.current_joints[name] = msg.position[i]

    def send_cmd(self, j1, j2, j3):
        """Motorlara güç ver"""
        self.pub_j1.publish(Float64(data=float(j1)))
        self.pub_j2.publish(Float64(data=float(j2)))
        self.pub_j3.publish(Float64(data=float(j3)))

    def wait_until_arrived(self, target_j1, target_j2, target_j3, tolerance=0.05):
        """
        Robot hedefe fiziksel olarak varana kadar kodu DONDURUR.
        Simülasyon yavaşsa burası da yavaşlar. Asla erken geçmez.
        """
        print(f"   ... Hedefe gidiliyor: [{target_j1}, {target_j2}, {target_j3}]")
        
        while rclpy.ok():
            rclpy.spin_once(self, timeout_sec=0.1) 
            
            if not self.data_received:
                continue

            curr_j1 = self.current_joints.get('world_yaw_joint', 0.0)
            curr_j2 = self.current_joints.get('j2_shoulder', 0.0)
            curr_j3 = self.current_joints.get('j3_elbow', 0.0)

            err_1 = abs(target_j1 - curr_j1)
            err_2 = abs(target_j2 - curr_j2)
            err_3 = abs(target_j3 - curr_j3)

            if err_1 < tolerance and err_2 < tolerance and err_3 < tolerance:
                print("VARIŞ ONAYLANDI.")
                break
            
            self.send_cmd(target_j1, target_j2, target_j3)
            time.sleep(0.05) 

    def move_sequence(self):
        while not self.data_received and rclpy.ok():
            print("Gazebo'dan veri bekleniyor... (Bridge açık mı?)")
            rclpy.spin_once(self, timeout_sec=1.0)

        while rclpy.ok():
            print("\n>>> A KONUMUNA GİDİLİYOR (MERKEZ)")
            self.wait_until_arrived(0.0, 0.0, 0.0)
            print("--- A Konumunda Bekleniyor (2 sn) ---")
            time.sleep(2.0)

            print("\n>>> B KONUMUNA GİDİLİYOR (SOL & EĞİL)")
            self.wait_until_arrived(1.5, 0.5, 0.5)
            print("--- B Konumunda Bekleniyor (2 sn) ---")
            time.sleep(2.0)

            print("\n>>> C KONUMUNA GİDİLİYOR (SAĞ & ÇOK EĞİL)")
            self.wait_until_arrived(-1.5, 1.0, 1.2)
            print("--- C Konumunda Bekleniyor (2 sn) ---")
            time.sleep(2.0)

def main(args=None):
    rclpy.init(args=args)
    controller = SmartArmController()
    
    try:
        controller.move_sequence()
    except KeyboardInterrupt:
        print("Durduruldu.")
    finally:
        controller.destroy_node()
        rclpy.shutdown()

if __name__ == '__main__':
    main()
